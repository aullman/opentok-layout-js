/*!
 *  opentok-layout-js (http://github.com/aullman/opentok-layout-js)
 *
 *  Automatic layout of video elements (publisher and subscriber) minimising
 *  white-space for the OpenTok on WebRTC API.
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
("undefined"==typeof module||"undefined"==typeof module.exports)&&(exports=window),function(t){var e=function(e,i,o,r,a,n){var g={left:i+"px",top:o+"px",width:r+"px",height:a+"px"},d=function(){var t=e.querySelector(".OT_root");if(t){var i=t.style.width;t.style.width=r+"px",t.style.width=i||""}};n&&t?(console.log("animate"),t(e).stop(),t(e).animate(g,n.duration||200,n.easing||"swing",function(){d(),n.complete&&n.complete.call(this)})):(e.style.left=g.left,e.style.top=g.top,e.style.width=g.width,e.style.height=g.height),d()},i=function(t,e){var i=window.getComputedStyle(t)[e];return i?parseInt(i,10):0},o=function(){return(1e8*Math.random()).toFixed(0)},r=function(t){return t.clientHeight},a=function(t){return t.clientWidth},n=function(t,e){var i,o={};for(i in t)t.hasOwnProperty(i)&&(o[i]=t[i]);for(i in e)e.hasOwnProperty(i)&&!o.hasOwnProperty(i)&&(o[i]=e[i]);return o},g=function(t,e,i,o,r){for(var a,n,g,d,l,h,u,f=1;i>=f;f++){var s=f,p=Math.ceil(i/s);u=Math.floor(r/p),h=Math.floor(o/s);var m=u/h;m>e?(m=e,u=h*m):t>m&&(m=t,h=u/m);var c=h*u*i;(void 0===a||c>a)&&(a=c,d=u,l=h,n=s,g=p)}return{maxArea:a,targetCols:n,targetRows:g,targetHeight:d,targetWidth:l}},d=function(t){return t&&t.videoHeight&&t.videoWidth?t.videoHeight/t.videoWidth:.75},l=function(t,o,r,a,n,l,h,u,f){var s=t.length;if(l){var p=t.length>0&&t[0].querySelector("video");h=u=d(p)}for(var m=g(h,u,s,o,r),c=m.targetRows*m.targetCols-s,b=c*m.targetWidth/2,y=(m.targetRows-1)*m.targetCols,R=(r-m.targetRows*m.targetHeight)/2,v=(o-m.targetCols*m.targetWidth)/2,x=0,w=0,M=0;M<t.length;M++){var C=t[M];M%m.targetCols===0?(x=v,M===y&&(x+=b),w+=0===M?R:m.targetHeight):x+=m.targetWidth,C.style.position="absolute";var S=m.targetWidth-i(C,"paddingLeft")-i(C,"paddingRight")-i(C,"marginLeft")-i(C,"marginRight")-i(C,"borderLeft")-i(C,"borderRight"),W=m.targetHeight-i(C,"paddingTop")-i(C,"paddingBottom")-i(C,"marginTop")-i(C,"marginBottom")-i(C,"borderTop")-i(C,"borderBottom");e(C,x+a,w+n,S,W,f)}},h=function(t){return"none"!==window.getComputedStyle(t).display},u=function(t,e){if(h(t)){var n=t.getAttribute("id");n||(n="OT_"+o(),t.setAttribute("id",n));var g,u=r(t)-i(t,"borderTop")-i(t,"borderBottom"),f=a(t)-i(t,"borderLeft")-i(t,"borderRight"),s=u/f,p=0,m=0,c=0,b=0,y=Array.prototype.filter.call(t.querySelectorAll("#"+n+">."+e.bigClass),h),R=Array.prototype.filter.call(t.querySelectorAll("#"+n+">*:not(."+e.bigClass+")"),h);if(y.length>0&&R.length>0){var v=y[0].querySelector("video");g=d(v);var x,w;s>g?(x=f,w=Math.min(Math.floor(u*e.bigPercentage),f*g),m=w,c=u-m):(w=u,x=Math.min(f*e.bigPercentage,Math.floor(w/g)),p=x,b=f-p),e.bigFirst?(l(y,x,w,0,0,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate),l(R,f-p,u-m,p,m,e.fixedRatio,e.minRatio,e.maxRatio,e.animate)):(l(R,f-p,u-m,0,0,e.fixedRatio,e.minRatio,e.maxRatio,e.animate),l(y,x,w,b,c,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate))}else y.length>0&&0===R.length?l(y,f,u,0,0,e.bigFixedRatio,e.bigMinRatio,e.bigMaxRatio,e.animate):l(R,f-p,u-m,p,m,e.fixedRatio,e.minRatio,e.maxRatio,e.animate)}};exports.initLayoutContainer=function(t,e){return e=n(e||{},{maxRatio:1.5,minRatio:9/16,fixedRatio:!1,animate:!1,bigClass:"OT_big",bigPercentage:.8,bigFixedRatio:!1,bigMaxRatio:1.5,bigMinRatio:9/16,bigFirst:!0}),t="string"==typeof t?document.querySelector(t):t,u(t,e),{layout:u.bind(null,t,e)}}}(window.hasOwnProperty("jQuery")?jQuery:void 0);